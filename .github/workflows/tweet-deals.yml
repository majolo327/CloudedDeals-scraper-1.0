name: Auto-Post Deals to Twitter

run-name: >-
  Tweet — ${{
    github.event_name == 'workflow_dispatch'
      && (github.event.inputs.dry_run == 'true' && 'dry-run' || 'manual')
    || 'scheduled'
  }}

on:
  schedule:
    # 4 tweet slots per day, spaced for NV local peak times (PST = UTC-8).
    # GitHub Actions crons can run 10-30 min late — that's fine.
    - cron: "0 17 * * *"   # Slot 1 — 9:00 AM PST  (morning commute)
    - cron: "0 20 * * *"   # Slot 2 — 12:00 PM PST (lunch break)
    - cron: "0 23 * * *"   # Slot 3 — 3:00 PM PST  (afternoon)
    - cron: "0 2 * * *"    # Slot 4 — 6:00 PM PST  (evening wind-down)
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (select deal but don't actually tweet)"
        required: false
        type: boolean
        default: false

concurrency:
  group: tweet-deals
  cancel-in-progress: false

jobs:
  tweet:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Post deal to Twitter
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          # Default to production URL if SITE_URL secret is not set
          BASE_URL="${SITE_URL:-https://cloudeddeals.com}"

          echo "=== Auto-Post Configuration ==="
          echo "Target:   ${BASE_URL}/api/deals/auto-post"
          echo "Dry run:  ${DRY_RUN}"
          echo "Time:     $(date -u '+%Y-%m-%d %H:%M UTC')"
          echo "==============================="

          BODY="{}"
          if [ "$DRY_RUN" = "true" ]; then
            BODY='{"dry_run": true}'
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST "${BASE_URL}/api/deals/auto-post" \
            -H "Authorization: Bearer ${ADMIN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          BODY=$(echo "$RESPONSE" | head -n -1)

          echo ""
          echo "HTTP Status: ${HTTP_CODE}"
          echo "Response:"
          echo "$BODY" | python3 -m json.tool 2>/dev/null || echo "$BODY"

          # Write to step summary
          echo "### Auto-Post Result" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$BODY" | python3 -m json.tool 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "$BODY" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Fail the job if the API returned an error
          if [ "$HTTP_CODE" -ge 400 ]; then
            echo "::error::Auto-post failed with HTTP ${HTTP_CODE}"
            exit 1
          fi
