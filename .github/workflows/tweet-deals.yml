name: Auto-Post Deals to Twitter

run-name: >-
  Tweet — ${{
    github.event_name == 'workflow_dispatch'
      && (github.event.inputs.test_connection == 'true' && 'connection-test'
          || github.event.inputs.dry_run == 'true' && 'dry-run'
          || 'manual')
    || 'scheduled'
  }}

on:
  schedule:
    # 8 tweet slots per day, spaced for NV local peak times (PDT = UTC-7).
    # DST-ADJUSTED (Mar 8 2026): shifted -1hr UTC to preserve local times.
    # GitHub Actions crons can run 10-30 min late — that's fine.
    - cron: "0 15 * * *"    # Slot 1 — 8:00 AM PDT  (early bird)
    - cron: "0 16 * * *"    # Slot 2 — 9:00 AM PDT  (morning commute)
    - cron: "30 17 * * *"   # Slot 3 — 10:30 AM PDT (mid-morning)
    - cron: "0 19 * * *"    # Slot 4 — 12:00 PM PDT (lunch break)
    - cron: "30 20 * * *"   # Slot 5 — 1:30 PM PDT  (early afternoon)
    - cron: "0 22 * * *"    # Slot 6 — 3:00 PM PDT  (afternoon)
    - cron: "30 23 * * *"   # Slot 7 — 4:30 PM PDT  (late afternoon)
    - cron: "0 1 * * *"     # Slot 8 — 6:00 PM PDT  (evening wind-down)
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (select deal but don't actually tweet)"
        required: false
        type: boolean
        default: false
      test_connection:
        description: "Test Twitter API credentials without posting"
        required: false
        type: boolean
        default: false

concurrency:
  group: tweet-deals
  cancel-in-progress: false

jobs:
  tweet:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - name: Post deal to Twitter
        env:
          SITE_URL: ${{ secrets.SITE_URL }}
          ADMIN_API_KEY: ${{ secrets.ADMIN_API_KEY }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
          TEST_CONNECTION: ${{ github.event.inputs.test_connection || 'false' }}
        run: |
          # Default to production URL if SITE_URL secret is not set
          BASE_URL="${SITE_URL:-https://cloudeddeals.com}"

          echo "=== Auto-Post Configuration ==="
          echo "Target:           ${BASE_URL}/api/deals/auto-post"
          echo "Dry run:          ${DRY_RUN}"
          echo "Test connection:  ${TEST_CONNECTION}"
          echo "Time:             $(date -u '+%Y-%m-%d %H:%M UTC')"
          echo "==============================="

          # Build request body based on mode
          if [ "$TEST_CONNECTION" = "true" ]; then
            BODY='{"test_connection": true}'
            echo "Mode: Testing Twitter API credentials..."
          elif [ "$DRY_RUN" = "true" ]; then
            BODY='{"dry_run": true}'
            echo "Mode: Dry run (no tweet will be posted)"
          else
            BODY='{}'
            echo "Mode: Live tweet"
          fi

          RESPONSE=$(curl -s -w "\n%{http_code}" \
            --retry 3 --retry-delay 5 --retry-all-errors \
            --max-time 25 \
            -X POST "${BASE_URL}/api/deals/auto-post" \
            -H "Authorization: Bearer ${ADMIN_API_KEY}" \
            -H "Content-Type: application/json" \
            -d "$BODY")

          HTTP_CODE=$(echo "$RESPONSE" | tail -1)
          RESP_BODY=$(echo "$RESPONSE" | head -n -1)

          echo ""
          echo "HTTP Status: ${HTTP_CODE}"
          echo "Response:"
          echo "$RESP_BODY" | python3 -m json.tool 2>/dev/null || echo "$RESP_BODY"

          # Write to step summary with error categorization
          echo "### Auto-Post Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "$HTTP_CODE" = "200" ]; then
            echo "**Status:** Success" >> $GITHUB_STEP_SUMMARY
          elif [ "$HTTP_CODE" = "401" ]; then
            echo "**Status:** Unauthorized — check ADMIN_API_KEY secret" >> $GITHUB_STEP_SUMMARY
          elif [ "$HTTP_CODE" = "502" ]; then
            echo "**Status:** Twitter API failure — check credentials in Netlify env vars" >> $GITHUB_STEP_SUMMARY
          elif [ "$HTTP_CODE" = "503" ]; then
            echo "**Status:** Twitter credentials not configured in Netlify" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** Failed (HTTP ${HTTP_CODE})" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          echo "$RESP_BODY" | python3 -m json.tool 2>/dev/null >> $GITHUB_STEP_SUMMARY || echo "$RESP_BODY" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

          # Fail the job if the API returned an error
          if [ "$HTTP_CODE" -ge 400 ] 2>/dev/null; then
            echo "::error::Auto-post failed with HTTP ${HTTP_CODE}"
            exit 1
          fi
